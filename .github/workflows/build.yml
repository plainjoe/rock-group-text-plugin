name: Build Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Verify Rock Dependencies
      shell: pwsh
      run: |
        $requiredDlls = @("Rock.dll", "Rock.Common.dll", "Rock.Enums.dll", "EntityFramework.dll")
        $missing = @()

        foreach ($dll in $requiredDlls) {
          if (-not (Test-Path "lib/$dll")) {
            $missing += $dll
          }
        }

        if ($missing.Count -gt 0) {
          Write-Error "Missing required DLLs in lib folder: $($missing -join ', ')"
          Write-Error "Please copy these DLLs from your Rock installation's bin folder."
          exit 1
        }

        Write-Host "All required dependencies found in lib folder."

    - name: Build
      run: msbuild com.plainjoe.GroupText.csproj /p:Configuration=Release /p:Platform="AnyCPU"

    - name: Prepare Artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path "artifacts/bin" -Force
        New-Item -ItemType Directory -Path "artifacts/Plugins/com_plainjoe/GroupText" -Force

        # Copy compiled DLL
        Copy-Item "bin/Release/com.plainjoe.GroupText.dll" -Destination "artifacts/bin/"

        # Copy block files
        Copy-Item "Blocks/*.ascx" -Destination "artifacts/Plugins/com_plainjoe/GroupText/"
        Copy-Item "Blocks/*.ascx.cs" -Destination "artifacts/Plugins/com_plainjoe/GroupText/"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GroupTextPlugin
        path: artifacts/
        retention-days: 30
